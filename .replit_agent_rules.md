# Replit Agent Rules - AI Shorts Studio

## Work Style

### Batch Work
- Complete full features before moving to the next
- Run verification after each major change
- Minimize file touches - change what's needed, nothing more

### Self-Repair
- If a test fails, fix it before proceeding
- If typecheck fails, fix types before moving on
- Never leave broken code behind

### Verify Required
- Every code change must pass `npm run typecheck`
- Features must work in `npm run verify` before marked complete
- MP4 must be playable, not just "file exists"

## Absolute Rules

### No Stock Footage
- NEVER use stock images, videos, or external media URLs
- All visuals must come from AI generation pipeline
- Only exception: placeholder assets in dummy mode

### No Double Processing
- Job locking prevents multiple workers on same job
- Idempotent steps skip if output already exists
- Hash-based asset paths ensure deterministic storage

### No Broken Completed Jobs
- MP4 integrity check MUST pass before status = 'completed'
- ffprobe must verify: duration > 0, audio stream exists, correct resolution
- If integrity fails: status = 'failed', not 'completed'

### Clean Temp Files
- Always cleanup /tmp/video-render/{jobId} on success, fail, or cancel
- Never leave orphaned temp files

## Definition of Done

A feature is NOT complete unless ALL are true:
1. `npm run typecheck` passes
2. `npm run verify` passes (creates 3 golden jobs with valid MP4)
3. Real MP4 previews work in UI
4. Progress/ETA/logs update live while running
5. Restart/resume works without double-processing
6. No stock footage anywhere

## Key Files

| Purpose | File |
|---------|------|
| Schema | `shared/schema.ts` |
| API Routes | `server/routes.ts` |
| Job Worker | `server/videoWorker.ts` |
| Video Renderer | `server/videoRenderer.ts` |
| AI Calls | `server/ai.ts` |
| Storage | `server/storage.ts` |
| Object Storage | `server/objectStorage.ts` |
| Verification | `scripts/verify.ts` |
| Design System | `design_guidelines.md` |
